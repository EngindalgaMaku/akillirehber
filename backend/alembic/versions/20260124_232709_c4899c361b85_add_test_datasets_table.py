"""Add test_datasets table

Revision ID: c4899c361b85
Revises: 024_add_giskard_tables
Create Date: 2026-01-24 23:27:09.727107

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision: str = 'c4899c361b85'
down_revision: Union[str, None] = '024_add_giskard_tables'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # Check existing tables and columns
    conn = op.get_bind()
    inspector = sa.inspect(conn)
    existing_tables = inspector.get_table_names()
    
    # Create test_datasets table if not exists
    if 'test_datasets' not in existing_tables:
        op.create_table('test_datasets',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('course_id', sa.Integer(), nullable=False),
        sa.Column('user_id', sa.Integer(), nullable=False),
        sa.Column('name', sa.String(length=255), nullable=False),
        sa.Column('description', sa.Text(), nullable=True),
        sa.Column('test_cases', sa.Text(), nullable=False),
        sa.Column('total_test_cases', sa.Integer(), nullable=False),
        sa.Column('created_at', sa.DateTime(), nullable=True),
        sa.Column('updated_at', sa.DateTime(), nullable=True),
        sa.ForeignKeyConstraint(['course_id'], ['courses.id'], ),
        sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
        sa.PrimaryKeyConstraint('id')
        )
        op.create_index(op.f('ix_test_datasets_id'), 'test_datasets', ['id'], unique=False)
    
    # Check if documents table has user_id column before altering
    if 'documents' in existing_tables:
        doc_columns = [col['name'] for col in inspector.get_columns('documents')]
        if 'user_id' in doc_columns:
            op.alter_column('documents', 'user_id',
                       existing_type=sa.INTEGER(),
                       nullable=False)
        
        # Alter embedding_status column
        if 'embedding_status' in doc_columns:
            # First create the enum type if it doesn't exist
            conn.execute(sa.text("""
                DO $$ BEGIN
                    CREATE TYPE embeddingstatus AS ENUM ('PENDING', 'PROCESSING', 'COMPLETED', 'ERROR');
                EXCEPTION
                    WHEN duplicate_object THEN null;
                END $$;
            """))
            
            # First drop the default to avoid casting issues
            op.alter_column('documents', 'embedding_status',
                       existing_type=sa.VARCHAR(length=20),
                       server_default=None)
            
            # Then alter the column type with explicit casting
            op.alter_column('documents', 'embedding_status',
                       existing_type=sa.VARCHAR(length=20),
                       type_=sa.Enum('PENDING', 'PROCESSING', 'COMPLETED', 'ERROR', name='embeddingstatus'),
                       nullable=False,
                       postgresql_using="embedding_status::embeddingstatus")
            
            # Finally set the new default
            op.alter_column('documents', 'embedding_status',
                       existing_type=sa.Enum('PENDING', 'PROCESSING', 'COMPLETED', 'ERROR', name='embeddingstatus'),
                       server_default=sa.text("'PENDING'::embeddingstatus"))
        
        if 'embedding_model' in doc_columns:
            op.alter_column('documents', 'embedding_model',
                       existing_type=sa.VARCHAR(length=100),
                       type_=sa.String(length=255),
                       existing_nullable=True)
        
        if 'embedded_at' in doc_columns:
            op.alter_column('documents', 'embedded_at',
                       existing_type=postgresql.TIMESTAMP(timezone=True),
                       type_=sa.DateTime(),
                       existing_nullable=True)


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_constraint(None, 'test_questions', type_='foreignkey')
    op.create_foreign_key(op.f('test_questions_test_set_id_fkey'), 'test_questions', 'test_sets', ['test_set_id'], ['id'], ondelete='CASCADE')
    op.drop_constraint(None, 'temporary_passwords', type_='foreignkey')
    op.create_foreign_key(op.f('temporary_passwords_user_id_fkey'), 'temporary_passwords', 'users', ['user_id'], ['id'], ondelete='CASCADE')
    op.create_index(op.f('ix_semantic_similarity_results_course_id'), 'semantic_similarity_results', ['course_id'], unique=False)
    op.create_index(op.f('ix_semantic_similarity_results_batch_session_id'), 'semantic_similarity_results', ['batch_session_id'], unique=False)
    op.drop_constraint(None, 'run_summaries', type_='foreignkey')
    op.create_foreign_key(op.f('run_summaries_run_id_fkey'), 'run_summaries', 'evaluation_runs', ['run_id'], ['id'], ondelete='CASCADE')
    op.drop_constraint(None, 'refresh_tokens', type_='foreignkey')
    op.create_foreign_key(op.f('refresh_tokens_user_id_fkey'), 'refresh_tokens', 'users', ['user_id'], ['id'], ondelete='CASCADE')
    op.create_index(op.f('ix_quick_test_results_group_name'), 'quick_test_results', ['group_name'], unique=False)
    op.create_index(op.f('ix_quick_test_results_course_id'), 'quick_test_results', ['course_id'], unique=False)
    op.create_unique_constraint(op.f('giskard_summaries_run_id_key'), 'giskard_summaries', ['run_id'], postgresql_nulls_not_distinct=False)
    op.drop_constraint(None, 'evaluation_runs', type_='foreignkey')
    op.create_foreign_key(op.f('evaluation_runs_test_set_id_fkey'), 'evaluation_runs', 'test_sets', ['test_set_id'], ['id'], ondelete='CASCADE')
    op.drop_constraint(None, 'evaluation_results', type_='foreignkey')
    op.drop_constraint(None, 'evaluation_results', type_='foreignkey')
    op.create_foreign_key(op.f('evaluation_results_question_id_fkey'), 'evaluation_results', 'test_questions', ['question_id'], ['id'], ondelete='CASCADE')
    op.create_foreign_key(op.f('evaluation_results_run_id_fkey'), 'evaluation_results', 'evaluation_runs', ['run_id'], ['id'], ondelete='CASCADE')
    op.alter_column('documents', 'embedded_at',
               existing_type=sa.DateTime(),
               type_=postgresql.TIMESTAMP(timezone=True),
               existing_nullable=True)
    op.alter_column('documents', 'embedding_model',
               existing_type=sa.String(length=255),
               type_=sa.VARCHAR(length=100),
               existing_nullable=True)
    # First drop the default to avoid casting issues
    op.alter_column('documents', 'embedding_status',
               existing_type=sa.Enum('PENDING', 'PROCESSING', 'COMPLETED', 'ERROR', name='embeddingstatus'),
               server_default=None)
    
    # Then alter the column type back to VARCHAR
    op.alter_column('documents', 'embedding_status',
               existing_type=sa.Enum('PENDING', 'PROCESSING', 'COMPLETED', 'ERROR', name='embeddingstatus'),
               type_=sa.VARCHAR(length=20),
               nullable=True,
               postgresql_using="embedding_status::character varying")
    
    # Finally set the original default
    op.alter_column('documents', 'embedding_status',
               existing_type=sa.VARCHAR(length=20),
               server_default=sa.text("'PENDING'::character varying"))
    op.alter_column('documents', 'user_id',
               existing_type=sa.INTEGER(),
               nullable=True)
    op.create_index(op.f('ix_chat_messages_created_at'), 'chat_messages', ['created_at'], unique=False)
    op.create_index(op.f('ix_chat_messages_course_user_id'), 'chat_messages', ['course_id', 'user_id', 'id'], unique=False)
    op.create_index(op.f('ix_batch_test_sessions_user_id'), 'batch_test_sessions', ['user_id'], unique=False)
    op.create_index(op.f('ix_batch_test_sessions_course_id'), 'batch_test_sessions', ['course_id'], unique=False)
    op.drop_constraint(None, 'audit_logs', type_='foreignkey')
    op.drop_constraint(None, 'audit_logs', type_='foreignkey')
    op.create_foreign_key(op.f('audit_logs_admin_user_id_fkey'), 'audit_logs', 'users', ['admin_user_id'], ['id'], ondelete='CASCADE')
    op.create_foreign_key(op.f('audit_logs_target_user_id_fkey'), 'audit_logs', 'users', ['target_user_id'], ['id'], ondelete='SET NULL')
    op.drop_index(op.f('ix_test_datasets_id'), table_name='test_datasets')
    op.drop_table('test_datasets')
    # ### end Alembic commands ###
