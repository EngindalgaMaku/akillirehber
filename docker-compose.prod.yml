# Production mode - All services including frontend in Docker
# Usage: docker-compose -f docker-compose.prod.yml up -d --build

services:
  # ===========================================
  # Frontend Service - Next.js
  # ===========================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: rag-frontend
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://backend:8000
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - rag-network
    restart: unless-stopped

  # ===========================================
  # Backend Service - FastAPI
  # ===========================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: rag-backend
    ports:
      - "8000:8000"
    env_file:
      - ./.env
    environment:
      - DATABASE_URL=${DATABASE_URL:-}
      - WEAVIATE_URL=${WEAVIATE_URL:-}
      - SECRET_KEY=${SECRET_KEY:-your-super-secret-key-change-in-production}
      - ALGORITHM=${ALGORITHM:-HS256}
      - ACCESS_TOKEN_EXPIRE_MINUTES=${ACCESS_TOKEN_EXPIRE_MINUTES:-30}
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - CLAUDEGG_API_KEY=${CLAUDEGG_API_KEY:-}
      - APICLAUDEGG_API_KEY=${APICLAUDEGG_API_KEY:-}
      - GROQ_API_KEY=${GROQ_API_KEY:-}
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY:-}
      - COHERE_API_KEY=${COHERE_API_KEY:-}
      - DASHSCOPE_API_KEY=${DASHSCOPE_API_KEY:-}
      # Worker configuration for production
      - WORKERS=${WORKERS:-4}
      - THREADS=${THREADS:-4}
      - WORKER_CONNECTIONS=${WORKER_CONNECTIONS:-1000}
      - MAX_REQUESTS=${MAX_REQUESTS:-1000}
      - MAX_REQUESTS_JITTER=${MAX_REQUESTS_JITTER:-100}
      - GUNICORN_TIMEOUT=${GUNICORN_TIMEOUT:-300}
      - GUNICORN_KEEPALIVE=${GUNICORN_KEEPALIVE:-5}
      - GUNICORN_GRACEFUL_TIMEOUT=${GUNICORN_GRACEFUL_TIMEOUT:-30}
      - GUNICORN_BIND=${GUNICORN_BIND:-0.0.0.0:8000}
      - LOG_LEVEL=${LOG_LEVEL:-info}
    networks:
      - rag-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ===========================================
  # RAGAS Evaluation Service
  # ===========================================
  ragas:
    build:
      context: ./ragas_service
      dockerfile: Dockerfile
    container_name: rag-ragas
    ports:
      - "8001:8001"
    environment:
      # LLM Provider API Keys
      - GROQ_API_KEY=${GROQ_API_KEY:-}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - CLAUDEGG_API_KEY=${CLAUDEGG_API_KEY:-}
      - APICLAUDEGG_API_KEY=${APICLAUDEGG_API_KEY:-}
      # Optional: Force specific provider (groq, openrouter, openai, claudegg, apiclaudegg)
      - RAGAS_PROVIDER=${RAGAS_PROVIDER:-}
      # Optional: Override default model
      - RAGAS_MODEL=${RAGAS_MODEL:-}
    networks:
      - rag-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8001/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

networks:
  rag-network:
    driver: bridge
    name: rag-educational-network

volumes: {}
